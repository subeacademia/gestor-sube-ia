<div class="contrato-card" 
     [class]="'card-estado-' + getEstadoClass()"
     [draggable]="draggable"
     (dragstart)="onDragStart($event)"
     (click)="abrirModal()">
  
  <!-- Header ultra compacto -->
  <div class="contrato-header">
    <div class="codigo-section">
      <div class="codigo-icon">ğŸ“‹</div>
      <div class="codigo-info">
        <h3>{{ contrato.codigo || contrato.id }}</h3>
        <span class="fecha">{{ formatDate(contrato.fechaCreacionContrato) }}</span>
      </div>
    </div>
    <div class="estado-badge" [class]="'estado-' + getEstadoClass()">
      <span class="estado-icon">{{ getEstadoIcon() }}</span>
      <span class="estado-text">{{ contrato.estado }}</span>
    </div>
  </div>
  
  <!-- InformaciÃ³n ultra compacta -->
  <div class="contrato-body">
    <div class="titulo-section">
      <p class="titulo-text">{{ contrato.titulo }}</p>
    </div>
    
    <div class="cliente-section">
      <div class="cliente-info">
        <p class="cliente-nombre">{{ contrato.nombreCliente }}</p>
        <p class="cliente-empresa">{{ contrato.empresa }}</p>
        <p class="cliente-email">{{ contrato.emailCliente }}</p>
      </div>
    </div>
    
    <div class="info-row">
      <div class="total-info">
        <span class="info-icon">ğŸ’°</span>
        <span class="info-label">Total:</span>
        <span class="info-value">{{ formatCurrency(contrato.valorTotal) }}</span>
      </div>
    </div>

    <!-- Estado de firmas ultra compacto -->
    <div class="firmas-section" *ngIf="contrato.firmas">
      <div class="firmas-status">
        <div class="firma-item" [class.firmado]="contrato.firmas.representante">
          <span class="firma-icon">{{ contrato.firmas.representante ? 'âœ…' : 'â³' }}</span>
          <span class="firma-text">Rep.</span>
        </div>
        <div class="firma-item" [class.firmado]="contrato.firmas.cliente">
          <span class="firma-icon">{{ contrato.firmas.cliente ? 'âœ…' : 'â³' }}</span>
          <span class="firma-text">Cli.</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Acciones ultra compactas -->
  <div class="contrato-actions">
    <div class="estado-selector">
      <select 
        class="estado-select" 
        [value]="contrato.estado"
        (change)="onEstadoChange($event)"
        (click)="$event.stopPropagation()">
        <option value="Pendiente de Firma">â³ Pendiente</option>
        <option value="Enviado">ğŸ“¤ Enviado</option>
        <option value="Firmado">âœ… Firmado</option>
        <option value="Finalizado">ğŸ‰ Finalizado</option>
      </select>
    </div>
    
    <div class="action-buttons">
      <!-- BotÃ³n de descarga de PDF (solo si estÃ¡ firmado) -->
      <button 
        class="btn-action btn-info" 
        (click)="verPDF($event)" 
        title="Descargar PDF Firmado"
        *ngIf="isContratoFirmado() || tieneFirmas()">
        <span class="btn-icon">ğŸ“„</span>
      </button>
      
      <!-- BotÃ³n de ver PDF (si no estÃ¡ firmado) -->
      <button 
        class="btn-action btn-info" 
        (click)="verPDF($event)" 
        title="Ver PDF"
        *ngIf="!isContratoFirmado() && !tieneFirmas()">
        <span class="btn-icon">ğŸ‘ï¸</span>
      </button>
      
      <button 
        class="btn-action btn-success" 
        (click)="enviarFirma($event)" 
        title="Enviar para Firma"
        *ngIf="contrato.estado === 'Pendiente de Firma'">
        <span class="btn-icon">ğŸ“§</span>
      </button>
      
      <button 
        class="btn-action btn-primary" 
        (click)="firmarRepresentante($event)" 
        title="Firmar como Representante"
        *ngIf="contrato.estado === 'Pendiente de Firma' && !contrato.firmas?.representante">
        <span class="btn-icon">âœï¸</span>
      </button>
      
      <!-- BotÃ³n para eliminar firma del representante -->
      <button 
        class="btn-action btn-danger" 
        (click)="eliminarFirmaRepresentante($event)" 
        title="Eliminar Firma del Representante"
        *ngIf="contrato['firmaInternaBase64'] || contrato['firmaRepresentanteBase64']">
        <span class="btn-icon">ğŸ—‘ï¸</span>
      </button>
      
      <!-- BotÃ³n para eliminar firma del cliente -->
      <button 
        class="btn-action btn-danger" 
        (click)="eliminarFirmaCliente($event)" 
        title="Eliminar Firma del Cliente"
        *ngIf="contrato['firmaClienteBase64']">
        <span class="btn-icon">ğŸ—‘ï¸</span>
      </button>
      
      <button class="btn-action btn-warning" (click)="editarContratoCard($event)" title="Editar">
        <span class="btn-icon">âœï¸</span>
      </button>
      
      <button class="btn-action btn-danger" (click)="eliminarContrato($event)" title="Eliminar">
        <span class="btn-icon">ğŸ—‘ï¸</span>
      </button>
    </div>
  </div>
  
  <!-- Indicador de drag -->
  <div class="drag-indicator">
    <span class="drag-icon">â†•ï¸</span>
  </div>
</div>

<!-- Modal de detalles -->
<div class="modal-overlay" [class.show]="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“‹ Detalles del Contrato</h3>
      <button class="modal-close" (click)="cerrarModal()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <div class="detail-section">
        <h4>ğŸ“‹ InformaciÃ³n General</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">CÃ³digo:</span>
            <span class="detail-value">{{ contrato.codigo || contrato.id }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Fecha:</span>
            <span class="detail-value">{{ formatDate(contrato.fechaCreacionContrato) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Estado:</span>
            <span class="detail-value estado-badge" [class]="'estado-' + getEstadoClass()">
              {{ getEstadoIcon() }} {{ contrato.estado }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>ğŸ“„ InformaciÃ³n del Contrato</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">TÃ­tulo:</span>
            <span class="detail-value">{{ contrato.titulo }}</span>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>ğŸ‘¤ InformaciÃ³n del Cliente</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Nombre:</span>
            <span class="detail-value">{{ contrato.nombreCliente }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Empresa:</span>
            <span class="detail-value">{{ contrato.empresa }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Email:</span>
            <span class="detail-value">{{ contrato.emailCliente }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">RUT:</span>
            <span class="detail-value">{{ contrato.rutCliente }}</span>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4>ğŸ’° InformaciÃ³n Financiera</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Total:</span>
            <span class="detail-value total">{{ formatCurrency(contrato.valorTotal) }}</span>
          </div>
        </div>
      </div>
      
      <div class="detail-section" *ngIf="contrato.firmas">
        <h4>âœï¸ Estado de Firmas</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Representante Legal:</span>
            <span class="detail-value" [class.firmado]="contrato.firmas.representante">
              {{ contrato.firmas.representante ? 'âœ… Firmado' : 'â³ Pendiente' }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Cliente:</span>
            <span class="detail-value" [class.firmado]="contrato.firmas.cliente">
              {{ contrato.firmas.cliente ? 'âœ… Firmado' : 'â³ Pendiente' }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="detail-section" *ngIf="contrato.historialEstados && contrato.historialEstados.length > 0">
        <h4>ğŸ“Š Historial de Estados</h4>
        <div class="detail-content">
          <div class="historial-item" *ngFor="let historial of contrato.historialEstados">
            <span class="historial-fecha">{{ formatDate(historial.fecha) }}</span>
            <span class="historial-estado">{{ historial.estado }}</span>
            <span class="historial-usuario">{{ historial.usuario }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
      
      <!-- BotÃ³n de descarga de PDF (solo si estÃ¡ firmado) -->
      <button 
        class="btn btn-info" 
        (click)="verPDF($event)" 
        *ngIf="isContratoFirmado() || tieneFirmas()">
        ğŸ“„ Descargar PDF Firmado
      </button>
      
      <!-- BotÃ³n de ver PDF (si no estÃ¡ firmado) -->
      <button 
        class="btn btn-info" 
        (click)="verPDF($event)" 
        *ngIf="!isContratoFirmado() && !tieneFirmas()">
        ğŸ‘ï¸ Ver PDF
      </button>
      
      <button class="btn btn-success" (click)="enviarFirma($event)" *ngIf="contrato.estado === 'Pendiente de Firma'">ğŸ“§ Enviar</button>
      <button class="btn btn-primary" (click)="firmarRepresentante($event)" *ngIf="contrato.estado === 'Pendiente de Firma' && !contrato.firmas?.representante">âœï¸ Firmar</button>
      <button class="btn btn-warning" (click)="editarContratoCard($event)">âœï¸ Editar</button>
      <button class="btn btn-danger" (click)="eliminarContrato($event)">ğŸ—‘ï¸ Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal de envÃ­o de firma -->
<div class="modal-overlay" [class.show]="mostrarModalEnvio" (click)="cerrarModalEnvio()">
  <div class="modal-content modal-envio" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“§ Enviar Contrato para Firma</h3>
      <button class="modal-close" (click)="cerrarModalEnvio()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <div class="envio-info">
        <h4>ğŸ“‹ InformaciÃ³n del Contrato</h4>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">CÃ³digo:</span>
            <span class="value">{{ contrato.codigo || contrato.id }}</span>
          </div>
          <div class="info-item">
            <span class="label">Cliente:</span>
            <span class="value">{{ contrato.nombreCliente }}</span>
          </div>
          <div class="info-item">
            <span class="label">Email:</span>
            <span class="value">{{ contrato.emailCliente }}</span>
          </div>
        </div>
      </div>
      
      <div class="envio-actions">
        <p>Â¿Deseas enviar este contrato al cliente para firma?</p>
        <p class="envio-note">Se generarÃ¡ un enlace seguro y se enviarÃ¡ por email al cliente.</p>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalEnvio()">Cancelar</button>
      <button class="btn btn-success" (click)="confirmarEnvio()">
        ğŸ“§ Enviar para Firma
      </button>
    </div>
  </div>
</div>
