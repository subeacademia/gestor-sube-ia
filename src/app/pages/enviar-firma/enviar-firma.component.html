<!-- Loading -->
<div *ngIf="loading" class="loading-envio">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Cargando contrato...</p>
  </div>
</div>

<!-- Error -->
<div *ngIf="error" class="error-envio">
  <div class="error-content">
    <span class="error-icon">âŒ</span>
    <h3>Error al cargar el contrato</h3>
    <p>{{ errorMessage }}</p>
    <button (click)="cargarContrato()" class="btn btn-primary">Reintentar</button>
  </div>
</div>

<!-- Contenido principal -->
<div *ngIf="!loading && !error && contrato" class="envio-container">
  <!-- Header -->
  <div class="envio-header">
    <h1>ğŸ“§ Enviar Firma al Cliente</h1>
    <p class="subtitle">Genera un enlace seguro para que el cliente firme el contrato</p>
  </div>

  <!-- Resumen del contrato -->
  <div class="contrato-resumen">
    <h2>ğŸ“‹ Resumen del Contrato</h2>
    
    <div class="resumen-grid">
      <div class="detalle-seccion">
        <h4>ğŸ“‹ InformaciÃ³n General</h4>
        <div class="info-item">
          <span class="label">TÃ­tulo:</span>
          <span class="value">{{ contrato.tituloContrato || contrato.titulo || 'Sin tÃ­tulo' }}</span>
        </div>
        <div class="info-item">
          <span class="label">CÃ³digo:</span>
          <span class="value codigo">{{ contrato.codigoCotizacion || contrato.codigo || 'Sin cÃ³digo' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Estado:</span>
          <span class="estado-badge" [ngClass]="getEstadoClass(contrato.estadoContrato)">
            {{ contrato.estadoContrato || 'Pendiente de Firma' }}
          </span>
        </div>
      </div>
      
      <div class="detalle-seccion">
        <h4>ğŸ‘¤ InformaciÃ³n del Cliente</h4>
        <div class="info-item">
          <span class="label">Nombre:</span>
          <span class="value">{{ contrato.cliente?.nombre || contrato.nombreCliente || 'No especificado' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Email:</span>
          <span class="value">{{ contrato.cliente?.email || contrato.emailCliente || 'No especificado' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Empresa:</span>
          <span class="value">{{ contrato.cliente?.empresa || contrato.empresa || 'No especificada' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- GeneraciÃ³n de link -->
  <div class="link-generacion">
    <h3>ğŸ”— Generar Link de Firma</h3>
    <p class="info-text">Genera un enlace Ãºnico y seguro para que el cliente pueda firmar el contrato digitalmente.</p>
    
    <div class="generacion-acciones">
      <button (click)="generarLinkFirma()" class="btn btn-primary" [disabled]="linkGenerado">
        {{ linkGenerado ? 'âœ… Link Generado' : 'ğŸ”— Generar Link de Firma' }}
      </button>
    </div>
    
    <!-- Link generado -->
    <div *ngIf="linkGenerado && linkFirmaGenerado" class="link-generado">
      <h4>âœ… Link de Firma Generado</h4>
      <div class="link-container">
        <input type="text" [value]="linkFirmaGenerado" readonly class="link-input">
        <button (click)="copiarLink()" class="btn btn-secondary btn-copiar">
          ğŸ“‹ Copiar
        </button>
      </div>
      <p class="link-info">Este enlace es Ãºnico y seguro. El cliente podrÃ¡ acceder directamente a la pÃ¡gina de firma.</p>
    </div>
  </div>

  <!-- EnvÃ­o de email -->
  <div class="email-envio" *ngIf="linkGenerado">
    <h3>ğŸ“§ Enviar Email al Cliente</h3>
    <p class="info-text">EnvÃ­a un email personalizado al cliente con el enlace de firma.</p>
    
    <div class="email-form">
      <div class="form-group">
        <label for="email-cliente">Email del Cliente:</label>
        <input 
          type="email" 
          id="email-cliente" 
          [(ngModel)]="emailCliente" 
          class="form-input"
          placeholder="email@ejemplo.com">
      </div>
      
      <div class="form-group">
        <label for="asunto-email">Asunto del Email:</label>
        <input 
          type="text" 
          id="asunto-email" 
          [(ngModel)]="asuntoEmail" 
          class="form-input"
          placeholder="Firma de Contrato - SUBE IA">
      </div>
      
      <div class="form-group">
        <label for="mensaje-email">Mensaje Personalizado:</label>
        <textarea 
          id="mensaje-email" 
          [(ngModel)]="mensajeEmail" 
          class="form-textarea"
          rows="8"
          placeholder="Estimado cliente, adjunto encontrarÃ¡ el enlace para firmar su contrato..."></textarea>
      </div>
      
      <div class="email-acciones">
        <button 
          (click)="enviarEmailFirma()" 
          class="btn btn-success" 
          [disabled]="enviandoEmail || emailEnviado">
          {{ enviandoEmail ? 'ğŸ“§ Enviando...' : emailEnviado ? 'âœ… Email Enviado' : 'ğŸ“§ Enviar Email' }}
        </button>
        
        <button 
          (click)="enviarEmailFallback(emailCliente, asuntoEmail, mensajeEmail)" 
          class="btn btn-warning"
          [disabled]="enviandoEmail">
          ğŸ“§ EnvÃ­o Manual
        </button>
      </div>
    </div>
    
    <!-- Estado del envÃ­o -->
    <div *ngIf="emailEnviado" class="email-enviado">
      <div class="mensaje-confirmacion">
        <h4>âœ… Email Enviado Exitosamente</h4>
        <p>El email ha sido enviado al cliente. El enlace de firma estÃ¡ activo y listo para ser utilizado.</p>
        <div class="acciones-post-envio">
          <button (click)="volverContratos()" class="btn btn-primary">
            ğŸ“‹ Volver a Contratos
          </button>
          <button (click)="generarLinkFirma()" class="btn btn-secondary">
            ğŸ”— Generar Nuevo Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- InformaciÃ³n adicional -->
  <div class="info-adicional">
    <h3>â„¹ï¸ InformaciÃ³n Importante</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-icon">ğŸ”’</span>
        <div class="info-content">
          <h4>Seguridad</h4>
          <p>El enlace generado es Ãºnico y seguro. Solo el cliente podrÃ¡ acceder a la pÃ¡gina de firma.</p>
        </div>
      </div>
      
      <div class="info-item">
        <span class="info-icon">â°</span>
        <div class="info-content">
          <h4>Vigencia</h4>
          <p>El enlace permanecerÃ¡ activo hasta que el contrato sea firmado o cancelado.</p>
        </div>
      </div>
      
      <div class="info-item">
        <span class="info-icon">ğŸ“±</span>
        <div class="info-content">
          <h4>Acceso</h4>
          <p>El cliente puede firmar desde cualquier dispositivo con acceso a internet.</p>
        </div>
      </div>
      
      <div class="info-item">
        <span class="info-icon">ğŸ“§</span>
        <div class="info-content">
          <h4>Notificaciones</h4>
          <p>RecibirÃ¡s una notificaciÃ³n cuando el cliente complete la firma del contrato.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones finales -->
  <div class="acciones-finales">
    <button (click)="volverContratos()" class="btn btn-secondary">
      ğŸ“‹ Volver a Contratos
    </button>
  </div>
</div> 