<!-- Loading -->
<div *ngIf="loading" class="loading-firma">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Cargando contrato...</p>
  </div>
</div>

<!-- Error -->
<div *ngIf="error" class="error-firma">
  <div class="error-content">
    <span class="error-icon">❌</span>
    <h3>Error al cargar el contrato</h3>
    <p>{{ errorMessage }}</p>
    <button (click)="cargarContrato()" class="btn btn-primary">Reintentar</button>
  </div>
</div>

<!-- Contenido principal -->
<div *ngIf="!loading && !error && contrato" class="firma-container">
  <!-- Header -->
  <div class="firma-header">
    <h1>✍️ Firma Digital de Contrato</h1>
    <p class="subtitle">Proceso de firma digital para {{ contrato.tituloContrato || contrato.titulo || 'Contrato' }}</p>
  </div>

  <!-- Resumen del contrato -->
  <div class="contrato-resumen">
    <h2>📋 Resumen del Contrato</h2>
    
    <div class="resumen-grid">
      <div class="detalle-seccion">
        <h4>📋 Información General</h4>
        <div class="info-item">
          <span class="label">Título:</span>
          <span class="value">{{ contrato.tituloContrato || contrato.titulo || 'Sin título' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Código:</span>
          <span class="value codigo">{{ contrato.codigoCotizacion || contrato.codigo || 'Sin código' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Estado:</span>
          <span class="estado-badge" [ngClass]="getEstadoClass(contrato.estadoContrato)">
            {{ contrato.estadoContrato || 'Pendiente de Firma' }}
          </span>
        </div>
        <div class="info-item">
          <span class="label">Fecha de Creación:</span>
          <span class="value">{{ formatearFecha(contrato.fechaCreacionContrato) }}</span>
        </div>
      </div>
      
      <div class="detalle-seccion">
        <h4>👤 Información del Cliente</h4>
        <div class="info-item">
          <span class="label">Nombre:</span>
          <span class="value">{{ contrato.cliente?.nombre || contrato.nombreCliente || 'No especificado' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Email:</span>
          <span class="value">{{ contrato.cliente?.email || contrato.emailCliente || 'No especificado' }}</span>
        </div>
        <div class="info-item">
          <span class="label">RUT:</span>
          <span class="value">{{ contrato.cliente?.rut || contrato.rutCliente || 'No especificado' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Empresa:</span>
          <span class="value">{{ contrato.cliente?.empresa || contrato.empresa || 'No especificada' }}</span>
        </div>
      </div>
      
      <div class="detalle-seccion">
        <h4>💰 Información Financiera</h4>
        <div class="info-item">
          <span class="label">Valor Total:</span>
          <span class="value total">{{ formatearMoneda(contrato.totalConDescuento || contrato.valorTotal || contrato.total || 0) }}</span>
        </div>
        <div class="info-item" *ngIf="contrato.descuento > 0">
          <span class="label">Descuento:</span>
          <span class="value descuento">{{ contrato.descuento }}%</span>
        </div>
        <div class="info-item">
          <span class="label">Atendido por:</span>
          <span class="value">{{ contrato.atendido || 'No especificado' }}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Área de firma -->
  <div class="firma-pad-container">
    <h3>✍️ Firma Digital - Doble Firma</h3>
    <div class="firma-info">
      <p>Este contrato requiere la firma del representante legal y del cliente para ser válido</p>
    </div>
    
    <!-- Firma del Representante Legal -->
    <div class="firma-seccion" [class.completada]="firmaRepresentanteGuardada">
      <div class="firma-header-seccion">
        <h4>👤 Firma del Representante Legal</h4>
        <div class="firma-status" [class.completada]="firmaRepresentanteGuardada">
          <span class="status-icon">{{ firmaRepresentanteGuardada ? '✅' : '⏳' }}</span>
          <span class="status-text">{{ firmaRepresentanteGuardada ? 'Completada' : 'Pendiente' }}</span>
        </div>
      </div>
      
      <!-- Selección de representante legal -->
      <div class="representante-seleccion" *ngIf="!firmaRepresentanteGuardada">
        <label for="representante-legal">Representante Legal:</label>
        <select id="representante-legal" [(ngModel)]="representanteSeleccionado" class="estado-select">
          <option value="">Selecciona un representante legal</option>
          <option *ngFor="let rep of representantes" [value]="rep.value">{{ rep.label }}</option>
        </select>
      </div>
      
      <!-- Información del representante si ya está firmado -->
      <div class="representante-info" *ngIf="firmaRepresentanteGuardada">
        <p><strong>Representante:</strong> {{ contrato.representanteLegal }}</p>
        <p><strong>Fecha de firma:</strong> {{ formatearFecha(contrato.fechaFirmaRepresentante) }}</p>
      </div>
      
      <!-- Área de firma del representante -->
      <div class="firma-area" *ngIf="!firmaRepresentanteGuardada">
        <label>Firma del Representante:</label>
        <div class="canvas-container">
          <canvas #firmaRepresentanteCanvas width="600" height="200"></canvas>
        </div>
        <div class="firma-acciones-seccion">
          <button (click)="limpiarFirmaRepresentante()" class="btn btn-secondary btn-limpiar-firma">
            🧹 Limpiar Firma
          </button>
          <button (click)="guardarFirmaRepresentante()" class="btn btn-primary" 
                  [disabled]="!representanteSeleccionado">
            Guardar Firma Representante
          </button>
        </div>
      </div>
    </div>
    
    <!-- Firma del Cliente -->
    <div class="firma-seccion" [class.completada]="firmaClienteGuardada">
      <div class="firma-header-seccion">
        <h4>👤 Firma del Cliente</h4>
        <div class="firma-status" [class.completada]="firmaClienteGuardada">
          <span class="status-icon">{{ firmaClienteGuardada ? '✅' : '⏳' }}</span>
          <span class="status-text">{{ firmaClienteGuardada ? 'Completada' : 'Pendiente' }}</span>
        </div>
      </div>
      
      <!-- Información del cliente -->
      <div class="cliente-info-firma">
        <p><strong>Cliente:</strong> <span>{{ contrato.cliente?.nombre || contrato.nombreCliente || 'No especificado' }}</span></p>
        <p><strong>Empresa:</strong> <span>{{ contrato.cliente?.empresa || contrato.empresa || 'No especificada' }}</span></p>
        <p *ngIf="firmaClienteGuardada"><strong>Fecha de firma:</strong> {{ formatearFecha(contrato.fechaFirmaCliente) }}</p>
      </div>
      
      <!-- Área de firma del cliente -->
      <div class="firma-area" *ngIf="!firmaClienteGuardada">
        <label>Firma del Cliente:</label>
        <div class="canvas-container">
          <canvas #firmaClienteCanvas width="600" height="200"></canvas>
        </div>
        <div class="firma-acciones-seccion">
          <button (click)="limpiarFirmaCliente()" class="btn btn-secondary btn-limpiar-firma">
            🧹 Limpiar Firma
          </button>
          <button (click)="guardarFirmaCliente()" class="btn btn-primary">
            Guardar Firma Cliente
          </button>
        </div>
      </div>
    </div>
    
    <!-- Estado de las firmas -->
    <div class="estado-firmas">
      <h4>📋 Estado de las Firmas</h4>
      <div class="firma-status">
        <div class="status-item" [class.completado]="firmaRepresentanteGuardada">
          <span class="status-icon">
            {{ firmaRepresentanteGuardada ? '✅' : '⏳' }}
          </span>
          <span class="status-text">
            Representante Legal: <span>{{ firmaRepresentanteGuardada ? 'Completada' : 'Pendiente' }}</span>
          </span>
        </div>
        <div class="status-item" [class.completado]="firmaClienteGuardada">
          <span class="status-icon">
            {{ firmaClienteGuardada ? '✅' : '⏳' }}
          </span>
          <span class="status-text">
            Cliente: <span>{{ firmaClienteGuardada ? 'Completada' : 'Pendiente' }}</span>
          </span>
        </div>
      </div>
    </div>
    
    <!-- Opciones de finalización cuando la firma del representante está completa -->
    <div *ngIf="firmaRepresentanteGuardada && !firmaClienteGuardada" class="firma-representante-completada">
      <div class="mensaje-confirmacion">
        <h3>✅ Firma del Representante Completada</h3>
        <p>La firma del representante legal ha sido guardada exitosamente.</p>
        <div class="opciones-finalizacion">
          <button (click)="generarLinkCliente()" class="btn btn-primary">
            🔗 Generar Link para Cliente
          </button>
          <button (click)="enviarEmailCliente()" class="btn btn-success">
            📧 Enviar Email al Cliente
          </button>
          <button (click)="volverContratos()" class="btn btn-secondary">
            📋 Volver a Contratos
          </button>
        </div>
      </div>
    </div>
    
    <!-- Mensaje cuando el contrato está completamente firmado -->
    <div *ngIf="firmaRepresentanteGuardada && firmaClienteGuardada" class="contrato-completamente-firmado">
      <div class="mensaje-confirmacion">
        <h3>🎉 ¡Contrato Completamente Firmado!</h3>
        <p>Ambas firmas han sido completadas. El contrato está listo para ser finalizado.</p>
        <div class="opciones-finalizacion">
          <button (click)="finalizarContrato()" class="btn btn-success">
            ✅ Finalizar Contrato
          </button>
          <button (click)="volverContratos()" class="btn btn-secondary">
            📋 Volver a Contratos
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
