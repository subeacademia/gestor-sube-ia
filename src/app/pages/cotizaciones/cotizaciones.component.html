<div class="admin-container">
  <app-header></app-header>

  <main class="admin-main">
    <!-- Secci√≥n de Estad√≠sticas con CSS Grid -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <h3>Total Cotizaciones</h3>
          <p>{{ totalCotizaciones }}</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-content">
          <h3>Este Mes</h3>
          <p>{{ cotizacionesMes }}</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <h3>Valor Total</h3>
          <p>{{ valorTotal | currency:'CLP':'symbol':'1.0-0' }}</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <h3>Total Aceptado</h3>
          <p>{{ totalAceptadas | currency:'CLP':'symbol':'1.0-0' }}</p>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Filtros y Acciones -->
    <div class="filters-section">
      <div class="filters-grid">
        <div class="search-group">
          <label for="buscador">üîç Buscar en tiempo real:</label>
          <input 
            type="text" 
            id="buscador" 
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
            placeholder="Buscar por c√≥digo, nombre, empresa, email, atendido..." 
            class="search-input">
        </div>
        <div class="filter-group">
          <label for="filtro-fecha">üìÖ Filtrar por fecha:</label>
          <select id="filtro-fecha" [(ngModel)]="filtroFecha" (change)="aplicarFiltros()">
            <option value="todos">Todos</option>
            <option value="hoy">Hoy</option>
            <option value="semana">Esta semana</option>
            <option value="mes">Este mes</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filtro-atendedor">üë§ Filtrar por atendido:</label>
          <select id="filtro-atendedor" [(ngModel)]="filtroAtendedor" (change)="aplicarFiltros()">
            <option value="todos">Todos</option>
            <option value="Rodrigo Carrillo">Rodrigo Carrillo</option>
            <option value="Bruno Villalobos">Bruno Villalobos</option>
            <option value="Mario Mu√±oz">Mario Mu√±oz</option>
            <option value="Nicol√°s Valenzuela">Nicol√°s Valenzuela</option>
            <option value="Ignacio Villarroel">Ignacio Villarroel</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filtro-estado">üè∑Ô∏è Filtrar por estado:</label>
          <select id="filtro-estado" [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
            <option value="todos">Todos los estados</option>
            <option value="Emitida">Emitida</option>
            <option value="Contestada">Contestada</option>
            <option value="En Negociaci√≥n">En Negociaci√≥n</option>
            <option value="Aceptada">Aceptada</option>
            <option value="Rechazada">Rechazada</option>
          </select>
        </div>
      </div>
      <div class="filter-buttons">
        <button (click)="aplicarFiltros()" class="btn btn-filter">
          <span class="btn-icon">üîç</span>
          Aplicar Filtros
        </button>

        <button (click)="navegarACrearCotizacion()" class="btn btn-primary">
          <span class="btn-icon">‚ûï</span>
          Crear Nueva Cotizaci√≥n
        </button>
        <button (click)="recargarDatos()" class="btn btn-reload">
          <span class="btn-icon">üîÑ</span>
          Recargar Datos
        </button>
      </div>
    </div>

    <!-- Secci√≥n de Cotizaciones -->
    <div class="cotizaciones-section">
      <div class="section-header">
        <h2>üìã Tablero de Cotizaciones</h2>
        <div class="view-toggle">
          <button 
            class="view-btn active" 
            (click)="setViewMode('kanban')"
            [class.active]="viewMode === 'kanban'">
            üìä Kanban
          </button>
          <button 
            class="view-btn" 
            (click)="setViewMode('list')"
            [class.active]="viewMode === 'list'">
            üìù Lista
          </button>
        </div>
      </div>
      
      <!-- Vista Kanban -->
      <div class="kanban-board" *ngIf="viewMode === 'kanban'">
        <!-- Columna: Emitida -->
        <div class="kanban-column" 
             [class.column-emitida]="true"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, 'Emitida')">
          <div class="kanban-column-header">
            <div class="column-icon">üìÑ</div>
            <div class="column-info">
              <h3>Emitida</h3>
              <span class="column-count">{{ getCotizacionesPorEstado('Emitida').length }}</span>
            </div>
          </div>
          <div class="kanban-column-content">
            <app-quote-card 
              *ngFor="let cotizacion of getCotizacionesPorEstado('Emitida')"
              [cotizacion]="cotizacion"
              [draggable]="true"
              (dragstart)="onDragStart($event, cotizacion)"
              (estadoChanged)="onEstadoChanged($event)"
              (cotizacionDeleted)="onCotizacionDeleted($event)"
              (generarContratoEvent)="onGenerarContrato($event)">
            </app-quote-card>
            <div class="empty-state" *ngIf="getCotizacionesPorEstado('Emitida').length === 0">
              <div class="empty-icon">üìÑ</div>
              <p>Sin cotizaciones emitidas</p>
            </div>
          </div>
        </div>
        
        <!-- Columna: Contestada -->
        <div class="kanban-column" 
             [class.column-contestada]="true"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, 'Contestada')">
          <div class="kanban-column-header">
            <div class="column-icon">üí¨</div>
            <div class="column-info">
              <h3>Contestada</h3>
              <span class="column-count">{{ getCotizacionesPorEstado('Contestada').length }}</span>
            </div>
          </div>
          <div class="kanban-column-content">
            <app-quote-card 
              *ngFor="let cotizacion of getCotizacionesPorEstado('Contestada')"
              [cotizacion]="cotizacion"
              [draggable]="true"
              (dragstart)="onDragStart($event, cotizacion)"
              (estadoChanged)="onEstadoChanged($event)"
              (cotizacionDeleted)="onCotizacionDeleted($event)"
              (generarContratoEvent)="onGenerarContrato($event)">
            </app-quote-card>
            <div class="empty-state" *ngIf="getCotizacionesPorEstado('Contestada').length === 0">
              <div class="empty-icon">üí¨</div>
              <p>Sin cotizaciones contestadas</p>
            </div>
          </div>
        </div>
        
        <!-- Columna: En Negociaci√≥n -->
        <div class="kanban-column" 
             [class.column-negociacion]="true"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, 'En Negociaci√≥n')">
          <div class="kanban-column-header">
            <div class="column-icon">ü§ù</div>
            <div class="column-info">
              <h3>En Negociaci√≥n</h3>
              <span class="column-count">{{ getCotizacionesPorEstado('En Negociaci√≥n').length }}</span>
            </div>
          </div>
          <div class="kanban-column-content">
            <app-quote-card 
              *ngFor="let cotizacion of getCotizacionesPorEstado('En Negociaci√≥n')"
              [cotizacion]="cotizacion"
              [draggable]="true"
              (dragstart)="onDragStart($event, cotizacion)"
              (estadoChanged)="onEstadoChanged($event)"
              (cotizacionDeleted)="onCotizacionDeleted($event)"
              (generarContratoEvent)="onGenerarContrato($event)">
            </app-quote-card>
            <div class="empty-state" *ngIf="getCotizacionesPorEstado('En Negociaci√≥n').length === 0">
              <div class="empty-icon">ü§ù</div>
              <p>Sin cotizaciones en negociaci√≥n</p>
            </div>
          </div>
        </div>
        
        <!-- Columna: Aceptada -->
        <div class="kanban-column" 
             [class.column-aceptada]="true"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, 'Aceptada')">
          <div class="kanban-column-header">
            <div class="column-icon">‚úÖ</div>
            <div class="column-info">
              <h3>Aceptada</h3>
              <span class="column-count">{{ getCotizacionesPorEstado('Aceptada').length }}</span>
            </div>
          </div>
          <div class="kanban-column-content">
            <app-quote-card 
              *ngFor="let cotizacion of getCotizacionesPorEstado('Aceptada')"
              [cotizacion]="cotizacion"
              [draggable]="true"
              (dragstart)="onDragStart($event, cotizacion)"
              (estadoChanged)="onEstadoChanged($event)"
              (cotizacionDeleted)="onCotizacionDeleted($event)"
              (generarContratoEvent)="onGenerarContrato($event)">
            </app-quote-card>
            <div class="empty-state" *ngIf="getCotizacionesPorEstado('Aceptada').length === 0">
              <div class="empty-icon">‚úÖ</div>
              <p>Sin cotizaciones aceptadas</p>
            </div>
          </div>
        </div>
        
        <!-- Columna: Rechazada -->
        <div class="kanban-column" 
             [class.column-rechazada]="true"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, 'Rechazada')">
          <div class="kanban-column-header">
            <div class="column-icon">‚ùå</div>
            <div class="column-info">
              <h3>Rechazada</h3>
              <span class="column-count">{{ getCotizacionesPorEstado('Rechazada').length }}</span>
            </div>
          </div>
          <div class="kanban-column-content">
            <app-quote-card 
              *ngFor="let cotizacion of getCotizacionesPorEstado('Rechazada')"
              [cotizacion]="cotizacion"
              [draggable]="true"
              (dragstart)="onDragStart($event, cotizacion)"
              (estadoChanged)="onEstadoChanged($event)"
              (cotizacionDeleted)="onCotizacionDeleted($event)"
              (generarContratoEvent)="onGenerarContrato($event)">
            </app-quote-card>
            <div class="empty-state" *ngIf="getCotizacionesPorEstado('Rechazada').length === 0">
              <div class="empty-icon">‚ùå</div>
              <p>Sin cotizaciones rechazadas</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Vista Lista -->
      <div class="list-view" *ngIf="viewMode === 'list'">
        <div class="table-container">
          <table class="cotizaciones-table">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Cliente</th>
                <th>Empresa</th>
                <th>Valor Total</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Atendido Por</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cotizacion of cotizacionesFiltradas">
                <td>
                  <strong>{{ cotizacion.codigo }}</strong>
                </td>
                <td>{{ cotizacion.nombre }}</td>
                <td>{{ cotizacion.empresa }}</td>
                <td>{{ cotizacion.valorTotal | currency:'CLP':'symbol':'1.0-0' }}</td>
                <td>
                  <span class="estado-badge" [class]="'estado-' + cotizacion.estado.toLowerCase().replace(' ', '-')">
                    {{ cotizacion.estado }}
                  </span>
                </td>
                <td>{{ cotizacion.fechaCreacion | date:'dd/MM/yyyy' }}</td>
                <td>{{ cotizacion.atendido }}</td>
                <td>
                  <div class="acciones">
                    <button class="btn-action" (click)="editarCotizacion(cotizacion)" title="Editar">
                      ‚úèÔ∏è
                    </button>
                    <button class="btn-action" (click)="eliminarCotizacion(cotizacion.id)" title="Eliminar">
                      üóëÔ∏è
                    </button>
                    <button class="btn-action" (click)="generarContrato(cotizacion)" title="Generar Contrato">
                      üìÑ
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal de Vista Previa PDF -->
<div class="modal-overlay" [class.show]="mostrarModalPDF" (click)="cerrarModalPDF()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìÑ Vista Previa - {{ cotizacionSeleccionada?.codigo }}</h3>
      <button class="modal-close" (click)="cerrarModalPDF()">√ó</button>
    </div>
    
    <div class="modal-body" *ngIf="cotizacionSeleccionada">
      <div class="pdf-preview">
        <div class="pdf-header">
          <h1 class="pdf-title">COTIZACI√ìN</h1>
          <p class="pdf-subtitle">{{ cotizacionSeleccionada.codigo }}</p>
          <p class="pdf-subtitle">Fecha: {{ formatDate(cotizacionSeleccionada.fecha) }}</p>
        </div>

        <div class="pdf-section">
          <h3>üìã Informaci√≥n del Cliente</h3>
          <div class="pdf-info-grid">
            <div class="pdf-info-item">
              <span class="pdf-label">Nombre:</span>
              <span class="pdf-value">{{ cotizacionSeleccionada.nombre || 'No especificado' }}</span>
            </div>
            <div class="pdf-info-item">
              <span class="pdf-label">Empresa:</span>
              <span class="pdf-value">{{ cotizacionSeleccionada.empresa || 'No especificada' }}</span>
            </div>
            <div class="pdf-info-item">
              <span class="pdf-label">Email:</span>
              <span class="pdf-value">{{ cotizacionSeleccionada.email || 'No especificado' }}</span>
            </div>
            <div class="pdf-info-item">
              <span class="pdf-label">Atendido por:</span>
              <span class="pdf-value">{{ cotizacionSeleccionada.atendido || 'No especificado' }}</span>
            </div>
          </div>
        </div>

        <div class="pdf-section" *ngIf="cotizacionSeleccionada.servicios">
          <h3>üí∞ Servicios Cotizados</h3>
          <div class="pdf-services">
            <div class="pdf-service-item" *ngFor="let servicio of cotizacionSeleccionada.servicios">
              <div class="pdf-info-item">
                <span class="pdf-label">Servicio:</span>
                <span class="pdf-value">{{ servicio.nombre || 'Sin nombre' }}</span>
              </div>
              <div class="pdf-info-item">
                <span class="pdf-label">Detalle:</span>
                <span class="pdf-value">{{ servicio.detalle || 'Sin detalle' }}</span>
              </div>
              <div class="pdf-info-item">
                <span class="pdf-label">Modalidad:</span>
                <span class="pdf-value">{{ servicio.modalidad || 'No especificada' }}</span>
              </div>
              <div class="pdf-info-item">
                <span class="pdf-label">Alumnos:</span>
                <span class="pdf-value">{{ servicio.alumnos || 0 }}</span>
              </div>
              <div class="pdf-info-item">
                <span class="pdf-label">Subtotal:</span>
                <span class="pdf-value">{{ formatCurrency(servicio.subtotal || 0) }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="pdf-total">
          <div class="pdf-info-item">
            <span class="pdf-label">TOTAL:</span>
            <span class="pdf-value total">{{ formatCurrency(cotizacionSeleccionada.valor || 0) }}</span>
          </div>
        </div>

        <div class="pdf-footer">
          <p>Esta cotizaci√≥n es v√°lida por 30 d√≠as desde su emisi√≥n.</p>
          <p>Para cualquier consulta, contacte a {{ cotizacionSeleccionada.atendido || 'nuestro equipo' }}.</p>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalPDF()">Cerrar</button>
      <button class="btn btn-primary" (click)="descargarPDF()">üì• Descargar PDF</button>
    </div>
  </div>
</div>
